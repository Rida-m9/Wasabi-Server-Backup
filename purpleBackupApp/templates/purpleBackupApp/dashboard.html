{% extends "purpleBackupApp/base.html" %}
{% block title %}Dashboard ‚Äî PurpleBackup{% endblock %}

{% block content %}
<section>
 <style>
    /* Consistent styling with other pages */
    .stats {
      display: flex;
      gap: 2rem;
      margin: 1.75rem 0;
    }

    .card {
      background: linear-gradient(135deg, #e6e6fac9, #f5f3ff16); /* soft lavender gradient */
      border-radius: 14px;
      padding: 1.5rem;
      min-width: 180px;
      height: auto;
      box-shadow: 0 3px 8px rgba(107, 33, 168, 0.12); /* smooth outer shadow */
      flex: 1;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(107, 33, 168, 0.18);
    }

    .card strong {
      display: block;
      font-size: 0.95rem;
      font-weight: 600;
      color: #49416D;
    }

    .stat-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: #49416D;
      margin-top: 0.5rem;
      letter-spacing: -0.5px;
    }


    
    /* Section headings */
    h2 {
      color: #49416D;
      margin-bottom: 0.5rem;
      font-weight: 700;
      font-size: 1.9rem;
    }
    
    /* Button styles - IMPROVED */
    .btn {
      background: linear-gradient(to bottom, #E6E6FA, #6B21A8);
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      white-space: nowrap;
      transition: all 0.2s ease;
      box-shadow: 0 4px 6px rgba(107, 33, 168, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(107, 33, 168, 0.3);
      opacity: 0.95;
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(107, 33, 168, 0.2);
    }
    
    .btn.secondary {
      background: linear-gradient(to bottom, #f1f5f9, #e2e8f0);
      color: #475569;
      border: 1px solid #e2e8f0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      text-decoration: none;
    }
    
    .btn.secondary:hover {
      background: linear-gradient(to bottom, #e2e8f0, #d1d9e6);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      color: #374151;
      
    }
    
    /* Form elements */
    input[type="text"] {
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      flex: 1;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #49416D;
      box-shadow: 0 0 0 3px rgba(107, 33, 168, 0.1);
    }
    
    /* Recent activity */
    .activity-list {
      list-style: none;
      padding: 0;
      margin: 1.5rem 0;
    }
    
    .activity-item {
      padding: 1rem;
      border-bottom: 1px solid #f1f5f9;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: background-color 0.2s ease;
      border-radius: 10px;
    }
    
    .activity-item:hover {
      background-color: #faf5ff;
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      background: #faf5ff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6B21A8;
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    
    /* Quick actions */
    .quick-actions {
      display: flex;
      gap: 1.5rem;
      margin: 2rem 0;
      flex-wrap: wrap;
    }
    
    .action-card {
      background: linear-gradient(135deg, #e6e6fa6f, #f5f3ff0a);;
      border-radius: 16px;
      padding: 1.75rem;
      flex: 1;
      min-width: 280px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      border: 1px solid #f1f5f9;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .action-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
    }
    
    .action-card h3 {
      margin-top: 0;
      color: #49416D;
      font-weight: 600;
      font-size: 1.2rem;
      margin-bottom: 0.75rem;
    }
    
    .action-card p {
      color: #08080882;
      line-height: 1.5;
      margin-bottom: 1.5rem;
    }
    
    /* Progress indicator */
    #backup-progress {
        display: none;
        margin-top: 1.5rem;
        padding: 1.25rem;
        background: #d1fae586;       /* light green background */
        border-radius: 12px;
        border-left: 4px solid #065f46; /* dark green accent border */
        color: #065f46;            /* dark green text */
        font-weight: 500;
    }
    /* Muted text */
    .muted {
      color: #64748b;
      font-size: 0.95rem;
    }
  </style>

  <h2>Dashboard</h2>
  <p class="muted">Overview of your backup status and recent activity.</p>

  <!-- Stats -->
  <div class="stats">
    <div class="card">
      <strong>Total Buckets</strong>
      <div class="stat-value">{{ total_buckets }}</div>
    </div>
    <div class="card">
      <strong>Total Objects</strong>
      <div class="stat-value">{{ total_files }}</div>
    </div>
    <div class="card">
      <strong>Total Data Stored</strong>
      <div class="stat-value">{{ total_size_hr }}</div>
    </div>
    <div class="card">
      <strong>Last Backup</strong>
      <div class="stat-value">
        {% if last_backup_time %}
          {{ last_backup_time|timesince }} ago
        {% else %}
          Never
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <div class="action-card">
      <h3>Backup Operations</h3>
      <p>Initiate backup tasks for your storage buckets.</p>
      <div style="display: flex; gap: 12px; margin-top: 1.5rem;">
        <form id="backup-all-form" method="post" action="{% url 'trigger_backup_all' %}">
          {% csrf_token %}
          <button id="backup-all" class="btn secondary">
              üîÑ  Backup All Buckets
          </button>
        </form>
        <a href="{% url 'buckets' %}" class="btn secondary">
          üóëÔ∏è Manage Buckets
        </a>
      </div>
    </div>
    
    <div class="action-card">
      <h3>Search Files</h3>
      <p>Find specific files across all your backups.</p>
      <form method="get" action="{% url 'search_files' %}" style="display: flex; gap: 10px; margin-top: 1.5rem;">
        <input type="text" name="q" placeholder="Search files...">
        <button type="submit" class="btn secondary">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 5px;">
            <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
          </svg>
          Search
        </button>
      </form>
    </div>
  </div>
  
  <div id="backup-progress" style="display:none; margin-top: 1.5rem; padding: 1.25rem;"></div>

  <!-- Recent Activity -->
  <h3 style="color: #6B21A8; font-weight: 600; font-size: 1.4rem; margin-top: 2.5rem;">Recent Activity</h3>
  <div>
    {% if recent_activity %}
      <ul class="activity-list">
        {% for activity in recent_activity %}
          <li class="activity-item">
            <div class="activity-icon">
              {% if activity.type == 'backup' %}
                ‚ö°
              {% elif activity.type == 'search' %}
                üîç
              {% else %}
                ‚ÑπÔ∏è
              {% endif %}
            </div>
            <div>
              <div style="font-weight: 500;">{{ activity.message }}</div>
              <div class="muted" style="font-size: 0.85rem; margin-top: 4px;">{{ activity.timestamp|timesince }} ago</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="muted">No recent activity.</p>
    {% endif %}
  </div>
</section>

<script>
const form = document.getElementById('backup-all-form');
const progressDiv = document.getElementById('backup-progress');

if (form) {
  form.addEventListener('submit', function(e){
      e.preventDefault();
      const csrftoken = form.querySelector('input[name="csrfmiddlewaretoken"]').value;

      progressDiv.style.display = 'block';
      

      fetch(form.action, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
      })
      .then(res => res.json())
      .then(data => {
          progressDiv.innerHTML = '';
          if (data.task_id) {
              const taskId = data.task_id;
              const statusDiv = document.createElement('div');
              statusDiv.innerText = 'Backup started (task id: ' + taskId + ')';
              progressDiv.appendChild(statusDiv);

              const interval = setInterval(() => {
                  fetch('/backup/status/' + taskId + '/')
                      .then(r => r.json())
                      .then(statusData => {
                          statusDiv.innerText = statusData.status || JSON.stringify(statusData);
                          // Check for completion states more broadly
                          if(statusData.status === 'Backup completed' || 
                             statusData.status === 'Backup failed' ||
                             statusData.status === 'All backups triggered' ||
                             statusData.status === 'SUCCESS' ||
                             statusData.status === 'FAILURE'){
                              clearInterval(interval);
                              // Reload the page to show updated status
                              setTimeout(() => { location.reload(); }, 2000);
                          }
                      })
                      .catch(err => {
                          statusDiv.innerText = ' checking status';
                          clearInterval(interval);
                      });
              }, 2000);
          } else {
              progressDiv.innerHTML = '<p>Failed to trigger backup</p>';
          }
      })
      .catch(err => {
          progressDiv.innerHTML = '<p>AJAX error</p>';
      });
  });
}
</script>
{% endblock %}